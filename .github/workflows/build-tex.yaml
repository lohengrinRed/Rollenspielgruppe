name: Build TeX and autosquash PDF

on:
  push:
    paths:
      - '**/*.tex'

jobs:
  build-pdf:
    # Safety guard 1: never run on commits created by GitHub Actions itself
    if: github.actor != 'github-actions[bot]'

    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-latex-base \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-lang-german \
            latexmk

      - name: Find changed TeX files
        id: tex
        run: |
          # Safety guard 2: skip commits explicitly marked [skip ci]
          if git log -1 --pretty=%B | grep -qi '\[skip ci\]'; then
            echo "none=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          git diff --name-only ${{ github.event.before }} ${{ github.sha }} \
            | grep '\.tex$' > tex_files.txt || true

          if [ ! -s tex_files.txt ]; then
            echo "none=true" >> $GITHUB_OUTPUT
          else
            echo "none=false" >> $GITHUB_OUTPUT
          fi

      - name: Verify Makefile exists (hard fail)
        if: steps.tex.outputs.none == 'false'
        run: |
          while read texfile; do
            DIR=$(dirname "$texfile")
            if [ ! -f "$DIR/Makefile" ]; then
              echo "::error file=$texfile::Missing Makefile in $DIR"
              exit 1
            fi
          done < tex_files.txt

      - name: Build PDFs
        if: steps.tex.outputs.none == 'false'
        run: |
          while read texfile; do
            DIR=$(dirname "$texfile")
            echo "Building in $DIR"
            pushd "$DIR"
            make
            popd
          done < tex_files.txt

      - name: Commit PDFs with --fixup
        if: steps.tex.outputs.none == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          while read texfile; do
            DIR=$(dirname "$texfile")

            TARGET_COMMIT=$(git log -n 1 --pretty=format:%H -- "$texfile")

            git add "$DIR"/*.pdf

            if git diff --cached --quiet; then
              echo "No PDF changes for $texfile"
              continue
            fi

            git commit --fixup="$TARGET_COMMIT"
          done < tex_files.txt

      - name: Autosquash rebase (since upstream)
        if: steps.tex.outputs.none == 'false'
        run: |
          export GIT_SEQUENCE_EDITOR=true

          BRANCH="${GITHUB_REF_NAME}"
          git fetch origin "$BRANCH"

          git rebase -i --autosquash "origin/$BRANCH"

      - name: Push changes
        if: steps.tex.outputs.none == 'false'
        run: |
          git push --force-with-lease

